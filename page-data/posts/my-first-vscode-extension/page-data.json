{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/posts/my-first-vscode-extension/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Programming Life","siteUrl":"https://blog.yury-chang.com"}},"markdownRemark":{"id":"bfdbc026-2a08-50f1-9b3c-008b771dbe0a","excerpt":"本篇的主角 Git patch stage - Visual Studio Marketplace 工作中有時會使用到 git add -p 指令，然而菜鳥如我用了大半年卻感到有些不便，手打檔案路徑實在是很麻煩，尤其是在結構複雜的專案中。 當然，我們可以到 vscode 的 folder view…","html":"<p><strong>本篇的主角</strong></p>\n<p><a href=\"https://marketplace.visualstudio.com/items?itemName=peterrabityu.git-patch-stage&#x26;ssr=false#overview\">Git patch stage - Visual Studio Marketplace</a></p>\n<p>工作中有時會使用到 git add -p 指令，然而菜鳥如我用了大半年卻感到有些不便，手打檔案路徑實在是很麻煩，尤其是在結構複雜的專案中。</p>\n<p>當然，我們可以到 vscode 的 folder view 上複製拉，但我往往都是打完 git patch -p 才想到需要去複製檔案路徑，鍵盤、滑鼠切換起來就有種卡卡的感覺。</p>\n<p>搜尋了一下 extension marketplace 居然沒找到相關的套件，由此萌生了自己製作 extension 的念頭。</p>\n<blockquote>\n<p>在完成這個迷你套件後不久，我就找到了內建的 Stage Selected Ranges 的功能…</p>\n</blockquote>\n<h2>How to do</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 310px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bfee2f7c884415bbc6b00740d8b7546f/5fad2/source-demo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.89873417721519%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIklEQVQozz2Qa27TUBCFvQxAaePEju34cf2Oc23HdpwXebSBllZIVVUQqhDsoGtgd2zoQ3Fof3yauWeOdM+Mksg5Vbvj8eknj9+eeXh65nj7wPcfvzje3JMVS/bX90zyBXm9oVrsmS8PzFdX1Isd9fJAuzqQyJY4q1GScs9ktqNef2H+8Y56fYucH2k3d+TNgWC6Zrb4TCQ3JPmWpNiSVXvy5pqiPVL+n53ZooyjBRcDC8306WsOquae0V2GhkAzBLoZdHUw8hi86qaPZvidr6+59FSLkahRxmHDpapjuyGW7eP5MZ6IMS2vwzDd82wsGBkOI9NlbPs4bnj2jAX9/pAP798x8opTwjnq0GSg2wxHDhcDs+NyaJ3r6a2ab/obqtFt1rscYoRrRPWI7spzQsPx8dKcdrljvb1md7jB9RN6qkFfG3M5HKPqNv1XtDPqyKV30UPe/eHq5S+6I1GMsCYyBLU1QXNCZNEwLRqS6YwgkYhoSphILDfC9mLGXowtYhw/wfVTdEvgiJQkKxnaEsWMGiIjJB0lmH5KWS2ZtWvkrKWsV2R5wzRv8IKUIMkJ06LTTh9OZIUXZliOIAp9dLdA0cWKr59cXn47pMWWxWpLs9xR1hvCeEqYlkSTkiyfk2QVTpCx2R0p6hWprNhsj8yqOUUuMf0axQoXTFOHthJ4cdklOxknskaEE9xg0q39ii0S/Fh2+qkPk7y7t+sFmH7FPz3wQsiGQXAyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"source-demo.png\"\n        title=\"source-demo.png\"\n        src=\"/static/bfee2f7c884415bbc6b00740d8b7546f/5fad2/source-demo.png\"\n        srcset=\"/static/bfee2f7c884415bbc6b00740d8b7546f/c26ae/source-demo.png 158w,\n/static/bfee2f7c884415bbc6b00740d8b7546f/5fad2/source-demo.png 310w\"\n        sizes=\"(max-width: 310px) 100vw, 310px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>看到 source control 檔案右邊的 <strong><code class=\"language-text\">+</code></strong> 按鈕，就想做一個類似的功能，但是並不會這麼常用，所以改成放在右鍵選單裡。</p>\n<p>為了達成上述的功能必須做到三件事：</p>\n<ol>\n<li>在右鍵選單上新增 git patch stage 選項</li>\n<li>點即時執行套件的程式，取得檔案的路徑</li>\n<li>使用上一步取得的檔案路徑自動執行 git add -p</li>\n</ol>\n<h2>Begin</h2>\n<p>一開始使用 scaffolds 來產生一個基本的模板。</p>\n<ol>\n<li>\n<p>安裝 scaffolds</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  $ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g yo generator-code</code></pre></div>\n</li>\n<li>\n<p>產生基本模板</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  $ yo code</code></pre></div>\n</li>\n<li>\n<p>按下 <code class=\"language-text\">F5</code> 執行測試</p>\n</li>\n</ol>\n<p>接著我們來介紹一下兩個對 extension 至關重要的檔案 <strong>Extension Manifest</strong> 和 <strong>Entry file。</strong></p>\n<h3>Extension Manifest</h3>\n<p>其實就是 package.json，但 VS Code 額外定義了一些屬於 VS Code extension 的屬性，參考 <a href=\"https://code.visualstudio.com/api/references/extension-manifest\">Extension Manifest Reference</a>。</p>\n<p>而幾個重要和常用的屬性有：</p>\n<ul>\n<li><code class=\"language-text\">name</code> , <code class=\"language-text\">publisher</code> : VS Code 會使用 <code class=\"language-text\">&lt;publisher>.&lt;name></code> 作為 extention 的 ID。</li>\n<li><code class=\"language-text\">main</code> : extention entry point。</li>\n<li><code class=\"language-text\">activationEvents</code>, <code class=\"language-text\">contributes</code> : 跟 extension 如何擴充 VS Code 有關，接著會詳細的介紹。</li>\n<li><code class=\"language-text\">engines.vscode</code> : extention 支援的 VS Code 最低版本</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">//  package.json</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"helloworld-sample\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"helloworld-sample\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HelloWorld example for VS Code\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.0.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"publisher\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"vscode-samples\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://github.com/microsoft/vscode-extension-samples/helloworld-sample\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"engines\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"vscode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^1.51.0\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"categories\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Other\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"activationEvents\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"onCommand:extension.helloWorld\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./out/extension.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"contributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"extension.helloWorld\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"title\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hello World\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"vscode:prepublish\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run compile\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"compile\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc -p ./\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"watch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc -watch -p ./\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"@types/node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^8.10.25\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"@types/vscode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^1.51.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"tslint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^5.16.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"typescript\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^3.4.5\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>基本概念</h2>\n<p>要了解 extension 是如何運作的，有三個基本的要素：</p>\n<ol>\n<li>\n<p><strong>Activation Event</strong></p>\n</li>\n<li>\n<p><strong>Contribution Points</strong></p>\n<p>在 package.json 中宣告，允許 command 可透過 command palette 和 UI 中使用。</p>\n</li>\n<li>\n<p><strong>VS Code API</strong></p>\n<p>vscode 提供讓 extension 呼叫的 API。</p>\n</li>\n</ol>\n<h3>Entry File</h3>\n<p><code class=\"language-text\">./out/extension.js</code> 是編譯後的檔案，指的其實就是 <code class=\"language-text\">./src/extension.ts</code>。</p>\n<p>VS Code extention 的入口檔匯出兩個 function，<code class=\"language-text\">activate</code> 和 <code class=\"language-text\">deactivate</code>。</p>\n<ul>\n<li><code class=\"language-text\">activate</code> 會在 <code class=\"language-text\">activationEvents</code> 觸發後執行。</li>\n<li><code class=\"language-text\">deactivate</code> 大多數的 extension 並不需要。</li>\n</ul>\n<p><code class=\"language-text\">activate</code> 內使用 <code class=\"language-text\">vscode.commands.registerCommand</code> 註冊了 extension.helloWorld command，每次使用 helloWorld，VS Code 都會去呼叫註冊的 call back，但 vscode 並不會在編輯器開啟時就執行套件的 <code class=\"language-text\">activate</code> function，這是為什麼會需要 <code class=\"language-text\">activationEvents</code> 的原因。</p>\n<p>User 可以在 command palette 或是 UI 介面上使用 <code class=\"language-text\">contributes</code> 中配置地的 command，但 command 實際的程式碼要等到 <code class=\"language-text\">activate</code> 執行時才會被註冊，所以我們才要額外透過 <code class=\"language-text\">activationEvents</code> 告訴 VS Code 在哪些指令觸發時要先執行相關套件的 <code class=\"language-text\">activate</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// src/extension.ts</span>\n<span class=\"token comment\">// The module 'vscode' contains the VS Code extensibility API</span>\n<span class=\"token comment\">// Import the module and reference it with the alias vscode in your code below</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> vscode <span class=\"token keyword\">from</span> <span class=\"token string\">'vscode'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// this method is called when your extension is activated</span>\n<span class=\"token comment\">// your extension is activated the very first time the command is executed</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">activate</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> vscode<span class=\"token punctuation\">.</span>ExtensionContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Use the console to output diagnostic information (console.log) and errors (console.error)</span>\n  <span class=\"token comment\">// This line of code will only be executed once when your extension is activated</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Congratulations, your extension \"helloworld-sample\" is now active!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// The command has been defined in the package.json file</span>\n  <span class=\"token comment\">// Now provide the implementation of the command with registerCommand</span>\n  <span class=\"token comment\">// The commandId parameter must match the command field in package.json</span>\n  <span class=\"token keyword\">let</span> disposable <span class=\"token operator\">=</span> vscode<span class=\"token punctuation\">.</span>commands<span class=\"token punctuation\">.</span><span class=\"token function\">registerCommand</span><span class=\"token punctuation\">(</span><span class=\"token string\">'extension.helloWorld'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// The code you place here will be executed every time your command is executed</span>\n\n    <span class=\"token comment\">// Display a message box to the user</span>\n    vscode<span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">showInformationMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  context<span class=\"token punctuation\">.</span>subscriptions<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>disposable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// this method is called when your extension is deactivated</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">deactivate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2>實戰演練</h2>\n<h3>新增 patch stage 選項</h3>\n<p>透過配置 <code class=\"language-text\">contributes</code>，當版控是 git，只要使用滑鼠右鍵點擊 working tree 中有變更的檔案，就可以看到由我們新增的 <code class=\"language-text\">patch stage</code> 選項。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"contributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"git-patch-stage.patch stage\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"title\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"patch stage\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"menus\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"scm/resourceState/context\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"git-patch-stage.patch stage\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"group\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"patch stage\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"when\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"scmProvider == git &amp;&amp; scmResourceGroup == workingTree\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><img src=\"/a663e3e7e0587a7c119b7b35f0a00ec1/patch-stage.gif\" alt=\"patch-stage.gif\"></p>\n<h3>套件主程式</h3>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> vscode <span class=\"token keyword\">from</span> <span class=\"token string\">'vscode'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">patchStage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>resourceStates<span class=\"token operator\">:</span> vscode<span class=\"token punctuation\">.</span>SourceControlResourceState<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> resourceState <span class=\"token operator\">=</span> resourceStates<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> filePath <span class=\"token operator\">=</span> vscode<span class=\"token punctuation\">.</span>workspace<span class=\"token punctuation\">.</span><span class=\"token function\">asRelativePath</span><span class=\"token punctuation\">(</span>resourceState<span class=\"token punctuation\">.</span>resourceUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n    <span class=\"token keyword\">const</span> newTerminal <span class=\"token operator\">=</span> vscode<span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">createTerminal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    newTerminal<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    newTerminal<span class=\"token punctuation\">.</span><span class=\"token function\">sendText</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">git add -p \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>filePath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>參考</h2>\n<p><a href=\"https://code.visualstudio.com/api/get-started/your-first-extension\">Your First Extension</a></p>","frontmatter":{"title":"My First VSCode Extension","date":"September 07, 2021","description":"關於我第一個 VSCode Extension 的故事 - Git patch stage"}},"previous":null,"next":{"fields":{"slug":"/posts/trouble-with-nbsp-space/"},"frontmatter":{"title":"空白? 被 &nbsp; 雷到的經驗"}}},"pageContext":{"id":"bfdbc026-2a08-50f1-9b3c-008b771dbe0a","previousPostId":null,"nextPostId":"e964559f-867a-5a0d-a3f2-8ab59f200c60"}},
    "staticQueryHashes": ["3000541721","3257411868"]}